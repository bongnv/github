"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _react = _interopRequireWildcard(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _branchView = _interopRequireDefault(require("../views/branch-view"));

var _branchMenuView = _interopRequireDefault(require("../views/branch-menu-view"));

var _pushPullView = _interopRequireDefault(require("../views/push-pull-view"));

var _changedFilesCountView = _interopRequireDefault(require("../views/changed-files-count-view"));

var _githubTileView = _interopRequireDefault(require("../views/github-tile-view"));

var _tooltip = _interopRequireDefault(require("../atom/tooltip"));

var _commands = _interopRequireWildcard(require("../atom/commands"));

var _observeModel = _interopRequireDefault(require("../views/observe-model"));

var _refHolder = _interopRequireDefault(require("../models/ref-holder"));

var _yubikiri = _interopRequireDefault(require("yubikiri"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class StatusBarTileController extends _react.default.Component {
  constructor(props) {
    super(props);

    _defineProperty(this, "fetchData", repository => {
      return (0, _yubikiri.default)({
        currentBranch: repository.getCurrentBranch(),
        branches: repository.getBranches(),
        statusesForChangedFiles: repository.getStatusesForChangedFiles(),
        currentRemote: async query => repository.getRemoteForBranch((await query.currentBranch).getName()),
        aheadCount: async query => repository.getAheadCount((await query.currentBranch).getName()),
        behindCount: async query => repository.getBehindCount((await query.currentBranch).getName()),
        originExists: async () => (await repository.getRemotes()).withName('origin').isPresent()
      });
    });

    _defineProperty(this, "handleOpenGitTimingsView", e => {
      e && e.preventDefault();
      this.props.workspace.open('atom-github://debug/timings');
    });

    _defineProperty(this, "checkout", (branchName, options) => {
      return this.props.repository.checkout(branchName, options);
    });

    this.refBranchViewRoot = new _refHolder.default();
  }

  getChangedFilesCount(data) {
    const {
      stagedFiles,
      unstagedFiles,
      mergeConflictFiles
    } = data.statusesForChangedFiles;
    const changedFiles = new Set();

    for (const filePath in unstagedFiles) {
      changedFiles.add(filePath);
    }

    for (const filePath in stagedFiles) {
      changedFiles.add(filePath);
    }

    for (const filePath in mergeConflictFiles) {
      changedFiles.add(filePath);
    }

    return changedFiles.size;
  }

  render() {
    return _react.default.createElement(_observeModel.default, {
      model: this.props.repository,
      fetchData: this.fetchData
    }, data => data ? this.renderWithData(data) : null);
  }

  renderWithData(data) {
    let changedFilesCount, mergeConflictsPresent;

    if (data.statusesForChangedFiles) {
      changedFilesCount = this.getChangedFilesCount(data);
      mergeConflictsPresent = Object.keys(data.statusesForChangedFiles.mergeConflictFiles).length > 0;
    }

    const repoProps = {
      repository: this.props.repository,
      currentBranch: data.currentBranch,
      branches: data.branches,
      currentRemote: data.currentRemote,
      aheadCount: data.aheadCount,
      behindCount: data.behindCount,
      originExists: data.originExists,
      changedFilesCount,
      mergeConflictsPresent
    };
    return _react.default.createElement(_react.Fragment, null, this.renderTiles(repoProps), _react.default.createElement(_githubTileView.default, {
      didClick: this.props.toggleGithubTab
    }), _react.default.createElement(_changedFilesCountView.default, {
      didClick: this.props.toggleGitTab,
      changedFilesCount: repoProps.changedFilesCount,
      mergeConflictsPresent: repoProps.mergeConflictsPresent
    }));
  }

  renderTiles(repoProps) {
    if (!this.props.repository.showStatusBarTiles()) {
      return null;
    }

    const operationStates = this.props.repository.getOperationStates();
    const pushInProgress = operationStates.isPushInProgress();
    const pullInProgress = operationStates.isPullInProgress();
    const fetchInProgress = operationStates.isFetchInProgress();
    return _react.default.createElement(_react.Fragment, null, _react.default.createElement(_commands.default, {
      registry: this.props.commands,
      target: "atom-workspace"
    }, _react.default.createElement(_commands.Command, {
      command: "github:fetch",
      callback: this.fetch(repoProps)
    }), _react.default.createElement(_commands.Command, {
      command: "github:pull",
      callback: this.pull(repoProps)
    }), _react.default.createElement(_commands.Command, {
      command: "github:push",
      callback: () => this.push(repoProps)({
        force: false,
        setUpstream: !repoProps.currentRemote.isPresent()
      })
    }), _react.default.createElement(_commands.Command, {
      command: "github:force-push",
      callback: () => this.push(repoProps)({
        force: true,
        setUpstream: !repoProps.currentRemote.isPresent()
      })
    })), _react.default.createElement(_branchView.default, {
      refRoot: this.refBranchViewRoot.setter,
      workspace: this.props.workspace,
      checkout: this.checkout,
      currentBranch: repoProps.currentBranch
    }), _react.default.createElement(_tooltip.default, {
      manager: this.props.tooltips,
      target: this.refBranchViewRoot,
      trigger: "click",
      className: "github-StatusBarTileController-tooltipMenu"
    }, _react.default.createElement(_branchMenuView.default, {
      workspace: this.props.workspace,
      notificationManager: this.props.notificationManager,
      commands: this.props.commands,
      checkout: this.checkout,
      branches: repoProps.branches,
      currentBranch: repoProps.currentBranch
    })), _react.default.createElement(_pushPullView.default, {
      isSyncing: fetchInProgress || pullInProgress || pushInProgress,
      isFetching: fetchInProgress,
      isPulling: pullInProgress,
      isPushing: pushInProgress,
      push: this.push(repoProps),
      pull: this.pull(repoProps),
      fetch: this.fetch(repoProps),
      tooltipManager: this.props.tooltips,
      currentBranch: repoProps.currentBranch,
      currentRemote: repoProps.currentRemote,
      behindCount: repoProps.behindCount,
      aheadCount: repoProps.aheadCount,
      originExists: repoProps.originExists
    }));
  }

  push(data) {
    return ({
      force,
      setUpstream
    } = {}) => {
      return this.props.repository.push(data.currentBranch.getName(), {
        force,
        setUpstream,
        refSpec: data.currentBranch.getRefSpec('PUSH')
      });
    };
  }

  pull(data) {
    return () => {
      return this.props.repository.pull(data.currentBranch.getName(), {
        refSpec: data.currentBranch.getRefSpec('PULL')
      });
    };
  }

  fetch(data) {
    return () => {
      const upstream = data.currentBranch.getUpstream();
      return this.props.repository.fetch(upstream.getRemoteRef(), {
        remoteName: upstream.getRemoteName()
      });
    };
  }

}

exports.default = StatusBarTileController;

_defineProperty(StatusBarTileController, "propTypes", {
  workspace: _propTypes.default.object.isRequired,
  notificationManager: _propTypes.default.object.isRequired,
  commands: _propTypes.default.object.isRequired,
  tooltips: _propTypes.default.object.isRequired,
  confirm: _propTypes.default.func.isRequired,
  repository: _propTypes.default.object.isRequired,
  toggleGitTab: _propTypes.default.func,
  toggleGithubTab: _propTypes.default.func
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9jb250cm9sbGVycy9zdGF0dXMtYmFyLXRpbGUtY29udHJvbGxlci5qcyJdLCJuYW1lcyI6WyJTdGF0dXNCYXJUaWxlQ29udHJvbGxlciIsIlJlYWN0IiwiQ29tcG9uZW50IiwiY29uc3RydWN0b3IiLCJwcm9wcyIsInJlcG9zaXRvcnkiLCJjdXJyZW50QnJhbmNoIiwiZ2V0Q3VycmVudEJyYW5jaCIsImJyYW5jaGVzIiwiZ2V0QnJhbmNoZXMiLCJzdGF0dXNlc0ZvckNoYW5nZWRGaWxlcyIsImdldFN0YXR1c2VzRm9yQ2hhbmdlZEZpbGVzIiwiY3VycmVudFJlbW90ZSIsInF1ZXJ5IiwiZ2V0UmVtb3RlRm9yQnJhbmNoIiwiZ2V0TmFtZSIsImFoZWFkQ291bnQiLCJnZXRBaGVhZENvdW50IiwiYmVoaW5kQ291bnQiLCJnZXRCZWhpbmRDb3VudCIsIm9yaWdpbkV4aXN0cyIsImdldFJlbW90ZXMiLCJ3aXRoTmFtZSIsImlzUHJlc2VudCIsImUiLCJwcmV2ZW50RGVmYXVsdCIsIndvcmtzcGFjZSIsIm9wZW4iLCJicmFuY2hOYW1lIiwib3B0aW9ucyIsImNoZWNrb3V0IiwicmVmQnJhbmNoVmlld1Jvb3QiLCJSZWZIb2xkZXIiLCJnZXRDaGFuZ2VkRmlsZXNDb3VudCIsImRhdGEiLCJzdGFnZWRGaWxlcyIsInVuc3RhZ2VkRmlsZXMiLCJtZXJnZUNvbmZsaWN0RmlsZXMiLCJjaGFuZ2VkRmlsZXMiLCJTZXQiLCJmaWxlUGF0aCIsImFkZCIsInNpemUiLCJyZW5kZXIiLCJmZXRjaERhdGEiLCJyZW5kZXJXaXRoRGF0YSIsImNoYW5nZWRGaWxlc0NvdW50IiwibWVyZ2VDb25mbGljdHNQcmVzZW50IiwiT2JqZWN0Iiwia2V5cyIsImxlbmd0aCIsInJlcG9Qcm9wcyIsInJlbmRlclRpbGVzIiwidG9nZ2xlR2l0aHViVGFiIiwidG9nZ2xlR2l0VGFiIiwic2hvd1N0YXR1c0JhclRpbGVzIiwib3BlcmF0aW9uU3RhdGVzIiwiZ2V0T3BlcmF0aW9uU3RhdGVzIiwicHVzaEluUHJvZ3Jlc3MiLCJpc1B1c2hJblByb2dyZXNzIiwicHVsbEluUHJvZ3Jlc3MiLCJpc1B1bGxJblByb2dyZXNzIiwiZmV0Y2hJblByb2dyZXNzIiwiaXNGZXRjaEluUHJvZ3Jlc3MiLCJjb21tYW5kcyIsImZldGNoIiwicHVsbCIsInB1c2giLCJmb3JjZSIsInNldFVwc3RyZWFtIiwic2V0dGVyIiwidG9vbHRpcHMiLCJub3RpZmljYXRpb25NYW5hZ2VyIiwicmVmU3BlYyIsImdldFJlZlNwZWMiLCJ1cHN0cmVhbSIsImdldFVwc3RyZWFtIiwiZ2V0UmVtb3RlUmVmIiwicmVtb3RlTmFtZSIsImdldFJlbW90ZU5hbWUiLCJQcm9wVHlwZXMiLCJvYmplY3QiLCJpc1JlcXVpcmVkIiwiY29uZmlybSIsImZ1bmMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7QUFFZSxNQUFNQSx1QkFBTixTQUFzQ0MsZUFBTUMsU0FBNUMsQ0FBc0Q7QUFZbkVDLEVBQUFBLFdBQVcsQ0FBQ0MsS0FBRCxFQUFRO0FBQ2pCLFVBQU1BLEtBQU47O0FBRGlCLHVDQXVCUEMsVUFBVSxJQUFJO0FBQ3hCLGFBQU8sdUJBQVM7QUFDZEMsUUFBQUEsYUFBYSxFQUFFRCxVQUFVLENBQUNFLGdCQUFYLEVBREQ7QUFFZEMsUUFBQUEsUUFBUSxFQUFFSCxVQUFVLENBQUNJLFdBQVgsRUFGSTtBQUdkQyxRQUFBQSx1QkFBdUIsRUFBRUwsVUFBVSxDQUFDTSwwQkFBWCxFQUhYO0FBSWRDLFFBQUFBLGFBQWEsRUFBRSxNQUFNQyxLQUFOLElBQWVSLFVBQVUsQ0FBQ1Msa0JBQVgsQ0FBOEIsQ0FBQyxNQUFNRCxLQUFLLENBQUNQLGFBQWIsRUFBNEJTLE9BQTVCLEVBQTlCLENBSmhCO0FBS2RDLFFBQUFBLFVBQVUsRUFBRSxNQUFNSCxLQUFOLElBQWVSLFVBQVUsQ0FBQ1ksYUFBWCxDQUF5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Z0IsbUJBQVVDLE1BQVYsQ0FBaUJDLFVBSFY7QUFJakJYLEVBQUFBLFFBQVEsRUFBRVMsbUJBQVVDLE1BQVYsQ0FBaUJDLFVBSlY7QUFLakJDLEVBQUFBLE9BQU8sRUFBRUgsbUJBQVVJLElBQVYsQ0FBZUYsVUFMUDtBQU1qQjdFLEVBQUFBLFVBQVUsRUFBRTJFLG1CQUFVQyxNQUFWLENBQWlCQyxVQU5aO0FBT2pCNUIsRUFBQUEsWUFBWSxFQUFFMEIsbUJBQVVJLElBUFA7QUFRakIvQixFQUFBQSxlQUFlLEVBQUUyQixtQkFBVUk7QUFSVixDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0LCB7RnJhZ21lbnR9IGZyb20gJ3JlYWN0JztcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcyc7XG5cbmltcG9ydCBCcmFuY2hWaWV3IGZyb20gJy4uL3ZpZXdzL2JyYW5jaC12aWV3JztcbmltcG9ydCBCcmFuY2hNZW51VmlldyBmcm9tICcuLi92aWV3cy9icmFuY2gtbWVudS12aWV3JztcbmltcG9ydCBQdXNoUHVsbFZpZXcgZnJvbSAnLi4vdmlld3MvcHVzaC1wdWxsLXZpZXcnO1xuaW1wb3J0IENoYW5nZWRGaWxlc0NvdW50VmlldyBmcm9tICcuLi92aWV3cy9jaGFuZ2VkLWZpbGVzLWNvdW50LXZpZXcnO1xuaW1wb3J0IEdpdGh1YlRpbGVWaWV3IGZyb20gJy4uL3ZpZXdzL2dpdGh1Yi10aWxlLXZpZXcnO1xuaW1wb3J0IFRvb2x0aXAgZnJvbSAnLi4vYXRvbS90b29sdGlwJztcbmltcG9ydCBDb21tYW5kcywge0NvbW1hbmR9IGZyb20gJy4uL2F0b20vY29tbWFuZHMnO1xuaW1wb3J0IE9ic2VydmVNb2RlbCBmcm9tICcuLi92aWV3cy9vYnNlcnZlLW1vZGVsJztcbmltcG9ydCBSZWZIb2xkZXIgZnJvbSAnLi4vbW9kZWxzL3JlZi1ob2xkZXInO1xuaW1wb3J0IHl1YmlraXJpIGZyb20gJ3l1YmlraXJpJztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgU3RhdHVzQmFyVGlsZUNvbnRyb2xsZXIgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQge1xuICBzdGF0aWMgcHJvcFR5cGVzID0ge1xuICAgIHdvcmtzcGFjZTogUHJvcFR5cGVzLm9iamVjdC5pc1JlcXVpcmVkLFxuICAgIG5vdGlmaWNhdGlvbk1hbmFnZXI6IFByb3BUeXBlcy5vYmplY3QuaXNSZXF1aXJlZCxcbiAgICBjb21tYW5kczogUHJvcFR5cGVzLm9iamVjdC5pc1JlcXVpcmVkLFxuICAgIHRvb2x0aXBzOiBQcm9wVHlwZXMub2JqZWN0LmlzUmVxdWlyZWQsXG4gICAgY29uZmlybTogUHJvcFR5cGVzLmZ1bmMuaXNSZXF1aXJlZCxcbiAgICByZXBvc2l0b3J5OiBQcm9wVHlwZXMub2JqZWN0LmlzUmVxdWlyZWQsXG4gICAgdG9nZ2xlR2l0VGFiOiBQcm9wVHlwZXMuZnVuYyxcbiAgICB0b2dnbGVHaXRodWJUYWI6IFByb3BUeXBlcy5mdW5jLFxuICB9XG5cbiAgY29uc3RydWN0b3IocHJvcHMpIHtcbiAgICBzdXBlcihwcm9wcyk7XG5cbiAgICB0aGlzLnJlZkJyYW5jaFZpZXdSb290ID0gbmV3IFJlZkhvbGRlcigpO1xuICB9XG5cbiAgZ2V0Q2hhbmdlZEZpbGVzQ291bnQoZGF0YSkge1xuICAgIGNvbnN0IHtzdGFnZWRGaWxlcywgdW5zdGFnZWRGaWxlcywgbWVyZ2VDb25mbGljdEZpbGVzfSA9IGRhdGEuc3RhdHVzZXNGb3JDaGFuZ2VkRmlsZXM7XG4gICAgY29uc3QgY2hhbmdlZEZpbGVzID0gbmV3IFNldCgpO1xuXG4gICAgZm9yIChjb25zdCBmaWxlUGF0aCBpbiB1bnN0YWdlZEZpbGVzKSB7XG4gICAgICBjaGFuZ2VkRmlsZXMuYWRkKGZpbGVQYXRoKTtcbiAgICB9XG4gICAgZm9yIChjb25zdCBmaWxlUGF0aCBpbiBzdGFnZWRGaWxlcykge1xuICAgICAgY2hhbmdlZEZpbGVzLmFkZChmaWxlUGF0aCk7XG4gICAgfVxuICAgIGZvciAoY29uc3QgZmlsZVBhdGggaW4gbWVyZ2VDb25mbGljdEZpbGVzKSB7XG4gICAgICBjaGFuZ2VkRmlsZXMuYWRkKGZpbGVQYXRoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gY2hhbmdlZEZpbGVzLnNpemU7XG4gIH1cblxuICBmZXRjaERhdGEgPSByZXBvc2l0b3J5ID0+IHtcbiAgICByZXR1cm4geXViaWtpcmkoe1xuICAgICAgY3VycmVudEJyYW5jaDogcmVwb3NpdG9yeS5nZXRDdXJyZW50QnJhbmNoKCksXG4gICAgICBicmFuY2hlczogcmVwb3NpdG9yeS5nZXRCcmFuY2hlcygpLFxuICAgICAgc3RhdHVzZXNGb3JDaGFuZ2VkRmlsZXM6IHJlcG9zaXRvcnkuZ2V0U3RhdHVzZXNGb3JDaGFuZ2VkRmlsZXMoKSxcbiAgICAgIGN1cnJlbnRSZW1vdGU6IGFzeW5jIHF1ZXJ5ID0+IHJlcG9zaXRvcnkuZ2V0UmVtb3RlRm9yQnJhbmNoKChhd2FpdCBxdWVyeS5jdXJyZW50QnJhbmNoKS5nZXROYW1lKCkpLFxuICAgICAgYWhlYWRDb3VudDogYXN5bmMgcXVlcnkgPT4gcmVwb3NpdG9yeS5nZXRBaGVhZENvdW50KChhd2FpdCBxdWVyeS5jdXJyZW50QnJhbmNoKS5nZXROYW1lKCkpLFxuICAgICAgYmVoaW5kQ291bnQ6IGFzeW5jIHF1ZXJ5ID0+IHJlcG9zaXRvcnkuZ2V0QmVoaW5kQ291bnQoKGF3YWl0IHF1ZXJ5LmN1cnJlbnRCcmFuY2gpLmdldE5hbWUoKSksXG4gICAgICBvcmlnaW5FeGlzdHM6IGFzeW5jICgpID0+IChhd2FpdCByZXBvc2l0b3J5LmdldFJlbW90ZXMoKSkud2l0aE5hbWUoJ29yaWdpbicpLmlzUHJlc2VudCgpLFxuICAgIH0pO1xuICB9XG5cbiAgcmVuZGVyKCkge1xuICAgIHJldHVybiAoXG4gICAgICA8T2JzZXJ2ZU1vZGVsIG1vZGVsPXt0aGlzLnByb3BzLnJlcG9zaXRvcnl9IGZldGNoRGF0YT17dGhpcy5mZXRjaERhdGF9PlxuICAgICAgICB7ZGF0YSA9PiAoZGF0YSA/IHRoaXMucmVuZGVyV2l0aERhdGEoZGF0YSkgOiBudWxsKX1cbiAgICAgIDwvT2JzZXJ2ZU1vZGVsPlxuICAgICk7XG4gIH1cblxuICByZW5kZXJXaXRoRGF0YShkYXRhKSB7XG4gICAgbGV0IGNoYW5nZWRGaWxlc0NvdW50LCBtZXJnZUNvbmZsaWN0c1ByZXNlbnQ7XG4gICAgaWYgKGRhdGEuc3RhdHVzZXNGb3JDaGFuZ2VkRmlsZXMpIHtcbiAgICAgIGNoYW5nZWRGaWxlc0NvdW50ID0gdGhpcy5nZXRDaGFuZ2VkRmlsZXNDb3VudChkYXRhKTtcbiAgICAgIG1lcmdlQ29uZmxpY3RzUHJlc2VudCA9IE9iamVjdC5rZXlzKGRhdGEuc3RhdHVzZXNGb3JDaGFuZ2VkRmlsZXMubWVyZ2VDb25mbGljdEZpbGVzKS5sZW5ndGggPiAwO1xuICAgIH1cblxuICAgIGNvbnN0IHJlcG9Qcm9wcyA9IHtcbiAgICAgIHJlcG9zaXRvcnk6IHRoaXMucHJvcHMucmVwb3NpdG9yeSxcbiAgICAgIGN1cnJlbnRCcmFuY2g6IGRhdGEuY3VycmVudEJyYW5jaCxcbiAgICAgIGJyYW5jaGVzOiBkYXRhLmJyYW5jaGVzLFxuICAgICAgY3VycmVudFJlbW90ZTogZGF0YS5jdXJyZW50UmVtb3RlLFxuICAgICAgYWhlYWRDb3VudDogZGF0YS5haGVhZENvdW50LFxuICAgICAgYmVoaW5kQ291bnQ6IGRhdGEuYmVoaW5kQ291bnQsXG4gICAgICBvcmlnaW5FeGlzdHM6IGRhdGEub3JpZ2luRXhpc3RzLFxuICAgICAgY2hhbmdlZEZpbGVzQ291bnQsXG4gICAgICBtZXJnZUNvbmZsaWN0c1ByZXNlbnQsXG4gICAgfTtcblxuICAgIHJldHVybiAoXG4gICAgICA8RnJhZ21lbnQ+XG4gICAgICAgIHt0aGlzLnJlbmRlclRpbGVzKHJlcG9Qcm9wcyl9XG4gICAgICAgIDxHaXRodWJUaWxlVmlldyBkaWRDbGljaz17dGhpcy5wcm9wcy50b2dnbGVHaXRodWJUYWJ9IC8+XG4gICAgICAgIDxDaGFuZ2VkRmlsZXNDb3VudFZpZXdcbiAgICAgICAgICBkaWRDbGljaz17dGhpcy5wcm9wcy50b2dnbGVHaXRUYWJ9XG4gICAgICAgICAgY2hhbmdlZEZpbGVzQ291bnQ9e3JlcG9Qcm9wcy5jaGFuZ2VkRmlsZXNDb3VudH1cbiAgICAgICAgICBtZXJnZUNvbmZsaWN0c1ByZXNlbnQ9e3JlcG9Qcm9wcy5tZXJnZUNvbmZsaWN0c1ByZXNlbnR9XG4gICAgICAgIC8+XG4gICAgICA8L0ZyYWdtZW50PlxuICAgICk7XG4gIH1cblxuICByZW5kZXJUaWxlcyhyZXBvUHJvcHMpIHtcbiAgICBpZiAoIXRoaXMucHJvcHMucmVwb3NpdG9yeS5zaG93U3RhdHVzQmFyVGlsZXMoKSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgY29uc3Qgb3BlcmF0aW9uU3RhdGVzID0gdGhpcy5wcm9wcy5yZXBvc2l0b3J5LmdldE9wZXJhdGlvblN0YXRlcygpO1xuICAgIGNvbnN0IHB1c2hJblByb2dyZXNzID0gb3BlcmF0aW9uU3RhdGVzLmlzUHVzaEluUHJvZ3Jlc3MoKTtcbiAgICBjb25zdCBwdWxsSW5Qcm9ncmVzcyA9IG9wZXJhdGlvblN0YXRlcy5pc1B1bGxJblByb2dyZXNzKCk7XG4gICAgY29uc3QgZmV0Y2hJblByb2dyZXNzID0gb3BlcmF0aW9uU3RhdGVzLmlzRmV0Y2hJblByb2dyZXNzKCk7XG5cbiAgICByZXR1cm4gKFxuICAgICAgPEZyYWdtZW50PlxuICAgICAgICA8Q29tbWFuZHMgcmVnaXN0cnk9e3RoaXMucHJvcHMuY29tbWFuZHN9IHRhcmdldD1cImF0b20td29ya3NwYWNlXCI+XG4gICAgICAgICAgPENvbW1hbmQgY29tbWFuZD1cImdpdGh1YjpmZXRjaFwiIGNhbGxiYWNrPXt0aGlzLmZldGNoKHJlcG9Qcm9wcyl9IC8+XG4gICAgICAgICAgPENvbW1hbmQgY29tbWFuZD1cImdpdGh1YjpwdWxsXCIgY2FsbGJhY2s9e3RoaXMucHVsbChyZXBvUHJvcHMpfSAvPlxuICAgICAgICAgIDxDb21tYW5kXG4gICAgICAgICAgICBjb21tYW5kPVwiZ2l0aHViOnB1c2hcIlxuICAgICAgICAgICAgY2FsbGJhY2s9eygpID0+IHRoaXMucHVzaChyZXBvUHJvcHMpKHtmb3JjZTogZmFsc2UsIHNldFVwc3RyZWFtOiAhcmVwb1Byb3BzLmN1cnJlbnRSZW1vdGUuaXNQcmVzZW50KCl9KX1cbiAgICAgICAgICAvPlxuICAgICAgICAgIDxDb21tYW5kXG4gICAgICAgICAgICBjb21tYW5kPVwiZ2l0aHViOmZvcmNlLXB1c2hcIlxuICAgICAgICAgICAgY2FsbGJhY2s9eygpID0+IHRoaXMucHVzaChyZXBvUHJvcHMpKHtmb3JjZTogdHJ1ZSwgc2V0VXBzdHJlYW06ICFyZXBvUHJvcHMuY3VycmVudFJlbW90ZS5pc1ByZXNlbnQoKX0pfVxuICAgICAgICAgIC8+XG4gICAgICAgIDwvQ29tbWFuZHM+XG4gICAgICAgIDxCcmFuY2hWaWV3XG4gICAgICAgICAgcmVmUm9vdD17dGhpcy5yZWZCcmFuY2hWaWV3Um9vdC5zZXR0ZXJ9XG4gICAgICAgICAgd29ya3NwYWNlPXt0aGlzLnByb3BzLndvcmtzcGFjZX1cbiAgICAgICAgICBjaGVja291dD17dGhpcy5jaGVja291dH1cbiAgICAgICAgICBjdXJyZW50QnJhbmNoPXtyZXBvUHJvcHMuY3VycmVudEJyYW5jaH1cbiAgICAgICAgLz5cbiAgICAgICAgPFRvb2x0aXBcbiAgICAgICAgICBtYW5hZ2VyPXt0aGlzLnByb3BzLnRvb2x0aXBzfVxuICAgICAgICAgIHRhcmdldD17dGhpcy5yZWZCcmFuY2hWaWV3Um9vdH1cbiAgICAgICAgICB0cmlnZ2VyPVwiY2xpY2tcIlxuICAgICAgICAgIGNsYXNzTmFtZT1cImdpdGh1Yi1TdGF0dXNCYXJUaWxlQ29udHJvbGxlci10b29sdGlwTWVudVwiPlxuICAgICAgICAgIDxCcmFuY2hNZW51Vmlld1xuICAgICAgICAgICAgd29ya3NwYWNlPXt0aGlzLnByb3BzLndvcmtzcGFjZX1cbiAgICAgICAgICAgIG5vdGlmaWNhdGlvbk1hbmFnZXI9e3RoaXMucHJvcHMubm90aWZpY2F0aW9uTWFuYWdlcn1cbiAgICAgICAgICAgIGNvbW1hbmRzPXt0aGlzLnByb3BzLmNvbW1hbmRzfVxuICAgICAgICAgICAgY2hlY2tvdXQ9e3RoaXMuY2hlY2tvdXR9XG4gICAgICAgICAgICBicmFuY2hlcz17cmVwb1Byb3BzLmJyYW5jaGVzfVxuICAgICAgICAgICAgY3VycmVudEJyYW5jaD17cmVwb1Byb3BzLmN1cnJlbnRCcmFuY2h9XG4gICAgICAgICAgLz5cbiAgICAgICAgPC9Ub29sdGlwPlxuICAgICAgICA8UHVzaFB1bGxWaWV3XG4gICAgICAgICAgaXNTeW5jaW5nPXtmZXRjaEluUHJvZ3Jlc3MgfHwgcHVsbEluUHJvZ3Jlc3MgfHwgcHVzaEluUHJvZ3Jlc3N9XG4gICAgICAgICAgaXNGZXRjaGluZz17ZmV0Y2hJblByb2dyZXNzfVxuICAgICAgICAgIGlzUHVsbGluZz17cHVsbEluUHJvZ3Jlc3N9XG4gICAgICAgICAgaXNQdXNoaW5nPXtwdXNoSW5Qcm9ncmVzc31cbiAgICAgICAgICBwdXNoPXt0aGlzLnB1c2gocmVwb1Byb3BzKX1cbiAgICAgICAgICBwdWxsPXt0aGlzLnB1bGwocmVwb1Byb3BzKX1cbiAgICAgICAgICBmZXRjaD17dGhpcy5mZXRjaChyZXBvUHJvcHMpfVxuICAgICAgICAgIHRvb2x0aXBNYW5hZ2VyPXt0aGlzLnByb3BzLnRvb2x0aXBzfVxuICAgICAgICAgIGN1cnJlbnRCcmFuY2g9e3JlcG9Qcm9wcy5jdXJyZW50QnJhbmNofVxuICAgICAgICAgIGN1cnJlbnRSZW1vdGU9e3JlcG9Qcm9wcy5jdXJyZW50UmVtb3RlfVxuICAgICAgICAgIGJlaGluZENvdW50PXtyZXBvUHJvcHMuYmVoaW5kQ291bnR9XG4gICAgICAgICAgYWhlYWRDb3VudD17cmVwb1Byb3BzLmFoZWFkQ291bnR9XG4gICAgICAgICAgb3JpZ2luRXhpc3RzPXtyZXBvUHJvcHMub3JpZ2luRXhpc3RzfVxuICAgICAgICAvPlxuICAgICAgPC9GcmFnbWVudD5cbiAgICApO1xuICB9XG5cbiAgaGFuZGxlT3BlbkdpdFRpbWluZ3NWaWV3ID0gZSA9PiB7XG4gICAgZSAmJiBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgdGhpcy5wcm9wcy53b3Jrc3BhY2Uub3BlbignYXRvbS1naXRodWI6Ly9kZWJ1Zy90aW1pbmdzJyk7XG4gIH1cblxuICBjaGVja291dCA9IChicmFuY2hOYW1lLCBvcHRpb25zKSA9PiB7XG4gICAgcmV0dXJuIHRoaXMucHJvcHMucmVwb3NpdG9yeS5jaGVja291dChicmFuY2hOYW1lLCBvcHRpb25zKTtcbiAgfVxuXG4gIHB1c2goZGF0YSkge1xuICAgIHJldHVybiAoe2ZvcmNlLCBzZXRVcHN0cmVhbX0gPSB7fSkgPT4ge1xuICAgICAgcmV0dXJuIHRoaXMucHJvcHMucmVwb3NpdG9yeS5wdXNoKGRhdGEuY3VycmVudEJyYW5jaC5nZXROYW1lKCksIHtcbiAgICAgICAgZm9yY2UsXG4gICAgICAgIHNldFVwc3RyZWFtLFxuICAgICAgICByZWZTcGVjOiBkYXRhLmN1cnJlbnRCcmFuY2guZ2V0UmVmU3BlYygnUFVTSCcpLFxuICAgICAgfSk7XG4gICAgfTtcbiAgfVxuXG4gIHB1bGwoZGF0YSkge1xuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICByZXR1cm4gdGhpcy5wcm9wcy5yZXBvc2l0b3J5LnB1bGwoZGF0YS5jdXJyZW50QnJhbmNoLmdldE5hbWUoKSwge1xuICAgICAgICByZWZTcGVjOiBkYXRhLmN1cnJlbnRCcmFuY2guZ2V0UmVmU3BlYygnUFVMTCcpLFxuICAgICAgfSk7XG4gICAgfTtcbiAgfVxuXG4gIGZldGNoKGRhdGEpIHtcbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgY29uc3QgdXBzdHJlYW0gPSBkYXRhLmN1cnJlbnRCcmFuY2guZ2V0VXBzdHJlYW0oKTtcbiAgICAgIHJldHVybiB0aGlzLnByb3BzLnJlcG9zaXRvcnkuZmV0Y2godXBzdHJlYW0uZ2V0UmVtb3RlUmVmKCksIHtcbiAgICAgICAgcmVtb3RlTmFtZTogdXBzdHJlYW0uZ2V0UmVtb3RlTmFtZSgpLFxuICAgICAgfSk7XG4gICAgfTtcbiAgfVxufVxuIl19