"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.source = void 0;

var _yubikiri = _interopRequireDefault(require("yubikiri"));

var _eventKit = require("event-kit");

var _relayNetworkLayerManager = _interopRequireDefault(require("../relay-network-layer-manager"));

var _author = _interopRequireWildcard(require("./author"));

var _keytarStrategy = require("../shared/keytar-strategy");

var _modelObserver = _interopRequireDefault(require("./model-observer"));

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

// This is a guess about what a reasonable value is. Can adjust if performance is poor.
const MAX_COMMITS = 5000;
const source = {
  PENDING: Symbol('pending'),
  GITLOG: Symbol('git log'),
  GITHUBAPI: Symbol('github API')
};
exports.source = source;

class GraphQLCache {
  // One hour
  constructor() {
    this.bySlug = new Map();
  }

  get(remote) {
    const slug = remote.getSlug();
    const {
      ts,
      data
    } = this.bySlug.get(slug) || {
      ts: -Infinity,
      data: {}
    };

    if (Date.now() - ts > this.constructor.MAX_AGE_MS) {
      this.bySlug.delete(slug);
      return null;
    }

    return data;
  }

  set(remote, data) {
    this.bySlug.set(remote.getSlug(), {
      ts: Date.now(),
      data
    });
  }

}

_defineProperty(GraphQLCache, "MAX_AGE_MS", 3.6e6);

class UserStore {
  constructor({
    repository,
    login,
    config
  }) {
    this.emitter = new _eventKit.Emitter();
    this.subs = new _eventKit.CompositeDisposable(); // TODO: [ku 3/2018] Consider using Dexie (indexDB wrapper) like Desktop and persist users across sessions

    this.allUsers = new Map();
    this.excludedUsers = new Set();
    this.users = [];
    this.committer = _author.nullAuthor;
    this.last = {
      source: source.PENDING,
      repository: null,
      excludedUsers: this.excludedUsers
    };
    this.cache = new GraphQLCache();
    this.repositoryObserver = new _modelObserver.default({
      fetchData: r => (0, _yubikiri.default)({
        committer: r.getCommitter(),
        authors: r.getAuthors({
          max: MAX_COMMITS
        }),
        remotes: r.getRemotes()
      }),
      didUpdate: () => this.loadUsers()
    });
    this.repositoryObserver.setActiveModel(repository);
    this.loginObserver = new _modelObserver.default({
      didUpdate: () => this.loadUsers()
    });
    this.loginObserver.setActiveModel(login);
    this.subs.add(config.observe('github.excludedUsers', value => {
      this.excludedUsers = new Set((value || '').split(/\s*,\s*/).filter(each => each.length > 0));
      return this.loadUsers();
    }));
  }

  dispose() {
    this.subs.dispose();
    this.emitter.dispose();
  }

  async loadUsers() {
    const data = this.repositoryObserver.getActiveModelData();

    if (!data) {
      return;
    }

    this.setCommitter(data.committer);
    const githubRemotes = Array.from(data.remotes).filter(remote => remote.isGithubRepo());

    if (githubRemotes.length > 0) {
      await this.loadUsersFromGraphQL(githubRemotes);
    } else {
      this.addUsers(data.authors, source.GITLOG);
    } // if for whatever reason, no committers can be added, fall back to
    // using git log committers as the last resort


    if (this.allUsers.size === 0) {
      this.addUsers(data.authors, source.GITLOG);
    }
  }

  loadUsersFromGraphQL(remotes) {
    return Promise.all(Array.from(remotes, remote => this.loadMentionableUsers(remote)));
  }

  async getToken(loginModel, loginAccount) {
    if (!loginModel) {
      return null;
    }

    const token = await loginModel.getToken(loginAccount);

    if (token === _keytarStrategy.UNAUTHENTICATED || token === _keytarStrategy.INSUFFICIENT || token instanceof Error) {
      return null;
    }

    return token;
  }

  async loadMentionableUsers(remote) {
    const cached = this.cache.get(remote);

    if (cached !== null) {
      this.addUsers(cached, source.GITHUBAPI);
      return;
    }

    const endpoint = remote.getEndpoint();
    const token = await this.getToken(this.loginObserver.getActiveModel(), endpoint.getLoginAccount());

    if (!token) {
      return;
    }

    const fetchQuery = _relayNetworkLayerManager.default.getFetchQuery(endpoint, token);

    let hasMore = true;
    let cursor = null;
    const remoteUsers = [];

    while (hasMore) {
      const response = await fetchQuery({
        name: 'GetMentionableUsers',
        text: `
          query GetMentionableUsers($owner: String!, $name: String!, $first: Int!, $after: String) {
            repository(owner: $owner, name: $name) {
              mentionableUsers(first: $first, after: $after) {
                nodes {
                  login
                  email
                  name
                }
                pageInfo {
                  hasNextPage
                  endCursor
                }
              }
            }
          }
        `
      }, {
        owner: remote.getOwner(),
        name: remote.getRepo(),
        first: 100,
        after: cursor
      });
      /* istanbul ignore if */

      if (response.errors && response.errors.length > 1) {
        // eslint-disable-next-line no-console
        console.error(`Error fetching mentionable users:\n${response.errors.map(e => e.message).join('\n')}`);
      }

      if (!response.data || !response.data.repository) {
        break;
      }

      const connection = response.data.repository.mentionableUsers;
      const authors = connection.nodes.map(node => {
        if (node.email === '') {
          node.email = `${node.login}@users.noreply.github.com`;
        }

        return new _author.default(node.email, node.name, node.login);
      });
      this.addUsers(authors, source.GITHUBAPI);
      remoteUsers.push(...authors);
      cursor = connection.pageInfo.endCursor;
      hasMore = connection.pageInfo.hasNextPage;
    }

    this.cache.set(remote, remoteUsers);
  }

  addUsers(users, nextSource) {
    let changed = false;

    if (nextSource !== this.last.source || this.repositoryObserver.getActiveModel() !== this.last.repository || this.excludedUsers !== this.last.excludedUsers) {
      changed = true;
      this.allUsers.clear();
    }

    for (const author of users) {
      if (!this.allUsers.has(author.getEmail())) {
        changed = true;
      }

      this.allUsers.set(author.getEmail(), author);
    }

    if (changed) {
      this.finalize();
    }

    this.last.source = nextSource;
    this.last.repository = this.repositoryObserver.getActiveModel();
    this.last.excludedUsers = this.excludedUsers;
  }

  finalize() {
    // TODO: [ku 3/2018] consider sorting based on most recent authors or commit frequency
    const users = [];

    for (const author of this.allUsers.values()) {
      if (author.matches(this.committer)) {
        continue;
      }

      if (author.isNoReply()) {
        continue;
      }

      if (this.excludedUsers.has(author.getEmail())) {
        continue;
      }

      users.push(author);
    }

    users.sort(_author.default.compare);
    this.users = users;
    this.didUpdate();
  }

  setRepository(repository) {
    this.repositoryObserver.setActiveModel(repository);
  }

  setLoginModel(login) {
    this.loginObserver.setActiveModel(login);
  }

  setCommitter(committer) {
    const changed = !this.committer.matches(committer);
    this.committer = committer;

    if (changed) {
      this.finalize();
    }
  }

  didUpdate() {
    this.emitter.emit('did-update', this.getUsers());
  }

  onDidUpdate(callback) {
    return this.emitter.on('did-update', callback);
  }

  getUsers() {
    return this.users;
  }

}

exports.default = UserStore;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9tb2RlbHMvdXNlci1zdG9yZS5qcyJdLCJuYW1lcyI6WyJNQVhfQ09NTUlUUyIsInNvdXJjZSIsIlBFTkRJTkciLCJTeW1ib2wiLCJHSVRMT0ciLCJHSVRIVUJBUEkiLCJHcmFwaFFMQ2FjaGUiLCJjb25zdHJ1Y3RvciIsImJ5U2x1ZyIsIk1hcCIsImdldCIsInJlbW90ZSIsInNsdWciLCJnZXRTbHVnIiwidHMiLCJkYXRhIiwiSW5maW5pdHkiLCJEYXRlIiwibm93IiwiTUFYX0FHRV9NUyIsImRlbGV0ZSIsInNldCIsIlVzZXJTdG9yZSIsInJlcG9zaXRvcnkiLCJsb2dpbiIsImNvbmZpZyIsImVtaXR0ZXIiLCJFbWl0dGVyIiwic3VicyIsIkNvbXBvc2l0ZURpc3Bvc2FibGUiLCJhbGxVc2VycyIsImV4Y2x1ZGVkVXNlcnMiLCJTZXQiLCJ1c2VycyIsImNvbW1pdHRlciIsIm51bGxBdXRob3IiLCJsYXN0IiwiY2FjaGUiLCJyZXBvc2l0b3J5T2JzZXJ2ZXIiLCJNb2RlbE9ic2VydmVyIiwiZmV0Y2hEYXRhIiwiciIsImdldENvbW1pdHRlciIsImF1dGhvcnMiLCJnZXRBdXRob3JzIiwibWF4IiwicmVtb3RlcyIsImdldFJlbW90ZXMiLCJkaWRVcGRhdGUiLCJsb2FkVXNlcnMiLCJzZXRBY3RpdmVNb2RlbCIsImxvZ2luT2JzZXJ2ZXIiLCJhZGQiLCJvYnNlcnZlIiwidmFsdWUiLCJzcGxpdCIsImZpbHRlciIsImVhY2giLCJsZW5ndGgiLCJkaXNwb3NlIiwiZ2V0QWN0aXZlTW9kZWxEYXRhIiwic2V0Q29tbWl0dGVyIiwiZ2l0aHViUmVtb3RlcyIsIkFycmF5IiwiZnJvbSIsImlzR2l0aHViUmVwbyIsImxvYWRVc2Vyc0Zyb21HcmFwaFFMIiwiYWRkVXNlcnMiLCJzaXplIiwiUHJvbWlzZSIsImFsbCIsImxvYWRNZW50aW9uYWJsZVVzZXJzIiwiZ2V0VG9rZW4iLCJsb2dpbk1vZGVsIiwibG9naW5BY2NvdW50IiwidG9rZW4iLCJVTkFVVEhFTlRJQ0FURUQiLCJJTlNVRkZJQ0lFTlQiLCJFcnJvciIsImNhY2hlZCIsImVuZHBvaW50IiwiZ2V0RW5kcG9pbnQiLCJnZXRBY3RpdmVNb2RlbCIsImdldExvZ2luQWNjb3VudCIsImZldGNoUXVlcnkiLCJSZWxheU5ldHdvcmtMYXllck1hbmFnZXIiLCJnZXRGZXRjaFF1ZXJ5IiwiaGFzTW9yZSIsImN1cnNvciIsInJlbW90ZVVzZXJzIiwicmVzcG9uc2UiLCJuYW1lIiwidGV4dCIsIm93bmVyIiwiZ2V0T3duZXIiLCJnZXRSZXBvIiwiZmlyc3QiLCJhZnRlciIsImVycm9ycyIsImNvbnNvbGUiLCJlcnJvciIsIm1hcCIsImUiLCJtZXNzYWdlIiwiam9pbiIsImNvbm5lY3Rpb24iLCJtZW50aW9uYWJsZVVzZXJzIiwibm9kZXMiLCJub2RlIiwiZW1haWwiLCJBdXRob3IiLCJwdXNoIiwicGFnZUluZm8iLCJlbmRDdXJzb3IiLCJoYXNOZXh0UGFnZSIsIm5leHRTb3VyY2UiLCJjaGFuZ2VkIiwiY2xlYXIiLCJhdXRob3IiLCJoYXMiLCJnZXRFbWFpbCIsImZpbmFsaXplIiwidmFsdWVzIiwibWF0Y2hlcyIsImlzTm9SZXBseSIsInNvcnQiLCJjb21wYXJlIiwic2V0UmVwb3NpdG9yeSIsInNldExvZ2luTW9kZWwiLCJlbWl0IiwiZ2V0VXNlcnMiLCJvbkRpZFVwZGF0ZSIsImNhbGxiYWNrIiwib24iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7QUFFQTtBQUNBLE1BQU1BLFdBQVcsR0FBRyxJQUFwQjtBQUVPLE1BQU1DLE1BQU0sR0FBRztBQUNwQkMsRUFBQUEsT0FBTyxFQUFFQyxNQUFNLENBQUMsU0FBRCxDQURLO0FBRXBCQyxFQUFBQSxNQUFNLEVBQUVELE1BQU0sQ0FBQyxTQUFELENBRk07QUFHcEJFLEVBQUFBLFNBQVMsRUFBRUYsTUFBTSxDQUFDLFlBQUQ7QUFIRyxDQUFmOzs7QUFNUCxNQUFNRyxZQUFOLENBQW1CO0FB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QixDQUFrQzFCLEtBQWxDO0FBQ0Q7O0FBRURxQyxFQUFBQSxZQUFZLENBQUMzQixTQUFELEVBQVk7QUFDdEIsVUFBTWtGLE9BQU8sR0FBRyxDQUFDLEtBQUtsRixTQUFMLENBQWV5RixPQUFmLENBQXVCekYsU0FBdkIsQ0FBakI7QUFDQSxTQUFLQSxTQUFMLEdBQWlCQSxTQUFqQjs7QUFDQSxRQUFJa0YsT0FBSixFQUFhO0FBQ1gsV0FBS0ssUUFBTDtBQUNEO0FBQ0Y7O0FBRUR6RSxFQUFBQSxTQUFTLEdBQUc7QUFDVixTQUFLdEIsT0FBTCxDQUFhdUcsSUFBYixDQUFrQixZQUFsQixFQUFnQyxLQUFLQyxRQUFMLEVBQWhDO0FBQ0Q7O0FBRURDLEVBQUFBLFdBQVcsQ0FBQ0MsUUFBRCxFQUFXO0FBQ3BCLFdBQU8sS0FBSzFHLE9BQUwsQ0FBYTJHLEVBQWIsQ0FBZ0IsWUFBaEIsRUFBOEJELFFBQTlCLENBQVA7QUFDRDs7QUFFREYsRUFBQUEsUUFBUSxHQUFHO0FBQ1QsV0FBTyxLQUFLakcsS0FBWjtBQUNEOztBQXRPNEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeXViaWtpcmkgZnJvbSAneXViaWtpcmknO1xuaW1wb3J0IHtFbWl0dGVyLCBDb21wb3NpdGVEaXNwb3NhYmxlfSBmcm9tICdldmVudC1raXQnO1xuXG5pbXBvcnQgUmVsYXlOZXR3b3JrTGF5ZXJNYW5hZ2VyIGZyb20gJy4uL3JlbGF5LW5ldHdvcmstbGF5ZXItbWFuYWdlcic7XG5pbXBvcnQgQXV0aG9yLCB7bnVsbEF1dGhvcn0gZnJvbSAnLi9hdXRob3InO1xuaW1wb3J0IHtVTkFVVEhFTlRJQ0FURUQsIElOU1VGRklDSUVOVH0gZnJvbSAnLi4vc2hhcmVkL2tleXRhci1zdHJhdGVneSc7XG5pbXBvcnQgTW9kZWxPYnNlcnZlciBmcm9tICcuL21vZGVsLW9ic2VydmVyJztcblxuLy8gVGhpcyBpcyBhIGd1ZXNzIGFib3V0IHdoYXQgYSByZWFzb25hYmxlIHZhbHVlIGlzLiBDYW4gYWRqdXN0IGlmIHBlcmZvcm1hbmNlIGlzIHBvb3IuXG5jb25zdCBNQVhfQ09NTUlUUyA9IDUwMDA7XG5cbmV4cG9ydCBjb25zdCBzb3VyY2UgPSB7XG4gIFBFTkRJTkc6IFN5bWJvbCgncGVuZGluZycpLFxuICBHSVRMT0c6IFN5bWJvbCgnZ2l0IGxvZycpLFxuICBHSVRIVUJBUEk6IFN5bWJvbCgnZ2l0aHViIEFQSScpLFxufTtcblxuY2xhc3MgR3JhcGhRTENhY2hlIHtcbiAgLy8gT25lIGhvdXJcbiAgc3RhdGljIE1BWF9BR0VfTVMgPSAzLjZlNlxuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMuYnlTbHVnID0gbmV3IE1hcCgpO1xuICB9XG5cbiAgZ2V0KHJlbW90ZSkge1xuICAgIGNvbnN0IHNsdWcgPSByZW1vdGUuZ2V0U2x1ZygpO1xuICAgIGNvbnN0IHt0cywgZGF0YX0gPSB0aGlzLmJ5U2x1Zy5nZXQoc2x1ZykgfHwge1xuICAgICAgdHM6IC1JbmZpbml0eSxcbiAgICAgIGRhdGE6IHt9LFxuICAgIH07XG5cbiAgICBpZiAoRGF0ZS5ub3coKSAtIHRzID4gdGhpcy5jb25zdHJ1Y3Rvci5NQVhfQUdFX01TKSB7XG4gICAgICB0aGlzLmJ5U2x1Zy5kZWxldGUoc2x1Zyk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgcmV0dXJuIGRhdGE7XG4gIH1cblxuICBzZXQocmVtb3RlLCBkYXRhKSB7XG4gICAgdGhpcy5ieVNsdWcuc2V0KHJlbW90ZS5nZXRTbHVnKCksIHt0czogRGF0ZS5ub3coKSwgZGF0YX0pO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFVzZXJTdG9yZSB7XG4gIGNvbnN0cnVjdG9yKHtyZXBvc2l0b3J5LCBsb2dpbiwgY29uZmlnfSkge1xuICAgIHRoaXMuZW1pdHRlciA9IG5ldyBFbWl0dGVyKCk7XG4gICAgdGhpcy5zdWJzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKTtcblxuICAgIC8vIFRPRE86IFtrdSAzLzIwMThdIENvbnNpZGVyIHVzaW5nIERleGllIChpbmRleERCIHdyYXBwZXIpIGxpa2UgRGVza3RvcCBhbmQgcGVyc2lzdCB1c2VycyBhY3Jvc3Mgc2Vzc2lvbnNcbiAgICB0aGlzLmFsbFVzZXJzID0gbmV3IE1hcCgpO1xuICAgIHRoaXMuZXhjbHVkZWRVc2VycyA9IG5ldyBTZXQoKTtcbiAgICB0aGlzLnVzZXJzID0gW107XG4gICAgdGhpcy5jb21taXR0ZXIgPSBudWxsQXV0aG9yO1xuXG4gICAgdGhpcy5sYXN0ID0ge1xuICAgICAgc291cmNlOiBzb3VyY2UuUEVORElORyxcbiAgICAgIHJlcG9zaXRvcnk6IG51bGwsXG4gICAgICBleGNsdWRlZFVzZXJzOiB0aGlzLmV4Y2x1ZGVkVXNlcnMsXG4gICAgfTtcbiAgICB0aGlzLmNhY2hlID0gbmV3IEdyYXBoUUxDYWNoZSgpO1xuXG4gICAgdGhpcy5yZXBvc2l0b3J5T2JzZXJ2ZXIgPSBuZXcgTW9kZWxPYnNlcnZlcih7XG4gICAgICBmZXRjaERhdGE6IHIgPT4geXViaWtpcmkoe1xuICAgICAgICBjb21taXR0ZXI6IHIuZ2V0Q29tbWl0dGVyKCksXG4gICAgICAgIGF1dGhvcnM6IHIuZ2V0QXV0aG9ycyh7bWF4OiBNQVhfQ09NTUlUU30pLFxuICAgICAgICByZW1vdGVzOiByLmdldFJlbW90ZXMoKSxcbiAgICAgIH0pLFxuICAgICAgZGlkVXBkYXRlOiAoKSA9PiB0aGlzLmxvYWRVc2VycygpLFxuICAgIH0pO1xuICAgIHRoaXMucmVwb3NpdG9yeU9ic2VydmVyLnNldEFjdGl2ZU1vZGVsKHJlcG9zaXRvcnkpO1xuXG4gICAgdGhpcy5sb2dpbk9ic2VydmVyID0gbmV3IE1vZGVsT2JzZXJ2ZXIoe1xuICAgICAgZGlkVXBkYXRlOiAoKSA9PiB0aGlzLmxvYWRVc2VycygpLFxuICAgIH0pO1xuICAgIHRoaXMubG9naW5PYnNlcnZlci5zZXRBY3RpdmVNb2RlbChsb2dpbik7XG5cbiAgICB0aGlzLnN1YnMuYWRkKFxuICAgICAgY29uZmlnLm9ic2VydmUoJ2dpdGh1Yi5leGNsdWRlZFVzZXJzJywgdmFsdWUgPT4ge1xuICAgICAgICB0aGlzLmV4Y2x1ZGVkVXNlcnMgPSBuZXcgU2V0KFxuICAgICAgICAgICh2YWx1ZSB8fCAnJykuc3BsaXQoL1xccyosXFxzKi8pLmZpbHRlcihlYWNoID0+IGVhY2gubGVuZ3RoID4gMCksXG4gICAgICAgICk7XG4gICAgICAgIHJldHVybiB0aGlzLmxvYWRVc2VycygpO1xuICAgICAgfSksXG4gICAgKTtcbiAgfVxuXG4gIGRpc3Bvc2UoKSB7XG4gICAgdGhpcy5zdWJzLmRpc3Bvc2UoKTtcbiAgICB0aGlzLmVtaXR0ZXIuZGlzcG9zZSgpO1xuICB9XG5cbiAgYXN5bmMgbG9hZFVzZXJzKCkge1xuICAgIGNvbnN0IGRhdGEgPSB0aGlzLnJlcG9zaXRvcnlPYnNlcnZlci5nZXRBY3RpdmVNb2RlbERhdGEoKTtcblxuICAgIGlmICghZGF0YSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMuc2V0Q29tbWl0dGVyKGRhdGEuY29tbWl0dGVyKTtcbiAgICBjb25zdCBnaXRodWJSZW1vdGVzID0gQXJyYXkuZnJvbShkYXRhLnJlbW90ZXMpLmZpbHRlcihyZW1vdGUgPT4gcmVtb3RlLmlzR2l0aHViUmVwbygpKTtcblxuICAgIGlmIChnaXRodWJSZW1vdGVzLmxlbmd0aCA+IDApIHtcbiAgICAgIGF3YWl0IHRoaXMubG9hZFVzZXJzRnJvbUdyYXBoUUwoZ2l0aHViUmVtb3Rlcyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuYWRkVXNlcnMoZGF0YS5hdXRob3JzLCBzb3VyY2UuR0lUTE9HKTtcbiAgICB9XG5cbiAgICAvLyBpZiBmb3Igd2hhdGV2ZXIgcmVhc29uLCBubyBjb21taXR0ZXJzIGNhbiBiZSBhZGRlZCwgZmFsbCBiYWNrIHRvXG4gICAgLy8gdXNpbmcgZ2l0IGxvZyBjb21taXR0ZXJzIGFzIHRoZSBsYXN0IHJlc29ydFxuICAgIGlmICh0aGlzLmFsbFVzZXJzLnNpemUgPT09IDApIHtcbiAgICAgIHRoaXMuYWRkVXNlcnMoZGF0YS5hdXRob3JzLCBzb3VyY2UuR0lUTE9HKTtcbiAgICB9XG4gIH1cblxuICBsb2FkVXNlcnNGcm9tR3JhcGhRTChyZW1vdGVzKSB7XG4gICAgcmV0dXJuIFByb21pc2UuYWxsKFxuICAgICAgQXJyYXkuZnJvbShyZW1vdGVzLCByZW1vdGUgPT4gdGhpcy5sb2FkTWVudGlvbmFibGVVc2VycyhyZW1vdGUpKSxcbiAgICApO1xuICB9XG5cbiAgYXN5bmMgZ2V0VG9rZW4obG9naW5Nb2RlbCwgbG9naW5BY2NvdW50KSB7XG4gICAgaWYgKCFsb2dpbk1vZGVsKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgY29uc3QgdG9rZW4gPSBhd2FpdCBsb2dpbk1vZGVsLmdldFRva2VuKGxvZ2luQWNjb3VudCk7XG4gICAgaWYgKHRva2VuID09PSBVTkFVVEhFTlRJQ0FURUQgfHwgdG9rZW4gPT09IElOU1VGRklDSUVOVCB8fCB0b2tlbiBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgcmV0dXJuIHRva2VuO1xuICB9XG5cbiAgYXN5bmMgbG9hZE1lbnRpb25hYmxlVXNlcnMocmVtb3RlKSB7XG4gICAgY29uc3QgY2FjaGVkID0gdGhpcy5jYWNoZS5nZXQocmVtb3RlKTtcbiAgICBpZiAoY2FjaGVkICE9PSBudWxsKSB7XG4gICAgICB0aGlzLmFkZFVzZXJzKGNhY2hlZCwgc291cmNlLkdJVEhVQkFQSSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgZW5kcG9pbnQgPSByZW1vdGUuZ2V0RW5kcG9pbnQoKTtcbiAgICBjb25zdCB0b2tlbiA9IGF3YWl0IHRoaXMuZ2V0VG9rZW4odGhpcy5sb2dpbk9ic2VydmVyLmdldEFjdGl2ZU1vZGVsKCksIGVuZHBvaW50LmdldExvZ2luQWNjb3VudCgpKTtcbiAgICBpZiAoIXRva2VuKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgZmV0Y2hRdWVyeSA9IFJlbGF5TmV0d29ya0xheWVyTWFuYWdlci5nZXRGZXRjaFF1ZXJ5KGVuZHBvaW50LCB0b2tlbik7XG5cbiAgICBsZXQgaGFzTW9yZSA9IHRydWU7XG4gICAgbGV0IGN1cnNvciA9IG51bGw7XG4gICAgY29uc3QgcmVtb3RlVXNlcnMgPSBbXTtcblxuICAgIHdoaWxlIChoYXNNb3JlKSB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoUXVlcnkoe1xuICAgICAgICBuYW1lOiAnR2V0TWVudGlvbmFibGVVc2VycycsXG4gICAgICAgIHRleHQ6IGBcbiAgICAgICAgICBxdWVyeSBHZXRNZW50aW9uYWJsZVVzZXJzKCRvd25lcjogU3RyaW5nISwgJG5hbWU6IFN0cmluZyEsICRmaXJzdDogSW50ISwgJGFmdGVyOiBTdHJpbmcpIHtcbiAgICAgICAgICAgIHJlcG9zaXRvcnkob3duZXI6ICRvd25lciwgbmFtZTogJG5hbWUpIHtcbiAgICAgICAgICAgICAgbWVudGlvbmFibGVVc2VycyhmaXJzdDogJGZpcnN0LCBhZnRlcjogJGFmdGVyKSB7XG4gICAgICAgICAgICAgICAgbm9kZXMge1xuICAgICAgICAgICAgICAgICAgbG9naW5cbiAgICAgICAgICAgICAgICAgIGVtYWlsXG4gICAgICAgICAgICAgICAgICBuYW1lXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHBhZ2VJbmZvIHtcbiAgICAgICAgICAgICAgICAgIGhhc05leHRQYWdlXG4gICAgICAgICAgICAgICAgICBlbmRDdXJzb3JcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIGAsXG4gICAgICB9LCB7XG4gICAgICAgIG93bmVyOiByZW1vdGUuZ2V0T3duZXIoKSxcbiAgICAgICAgbmFtZTogcmVtb3RlLmdldFJlcG8oKSxcbiAgICAgICAgZmlyc3Q6IDEwMCxcbiAgICAgICAgYWZ0ZXI6IGN1cnNvcixcbiAgICAgIH0pO1xuXG4gICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi9cbiAgICAgIGlmIChyZXNwb25zZS5lcnJvcnMgJiYgcmVzcG9uc2UuZXJyb3JzLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGVcbiAgICAgICAgY29uc29sZS5lcnJvcihgRXJyb3IgZmV0Y2hpbmcgbWVudGlvbmFibGUgdXNlcnM6XFxuJHtyZXNwb25zZS5lcnJvcnMubWFwKGUgPT4gZS5tZXNzYWdlKS5qb2luKCdcXG4nKX1gKTtcbiAgICAgIH1cblxuICAgICAgaWYgKCFyZXNwb25zZS5kYXRhIHx8ICFyZXNwb25zZS5kYXRhLnJlcG9zaXRvcnkpIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGNvbm5lY3Rpb24gPSByZXNwb25zZS5kYXRhLnJlcG9zaXRvcnkubWVudGlvbmFibGVVc2VycztcbiAgICAgIGNvbnN0IGF1dGhvcnMgPSBjb25uZWN0aW9uLm5vZGVzLm1hcChub2RlID0+IHtcbiAgICAgICAgaWYgKG5vZGUuZW1haWwgPT09ICcnKSB7XG4gICAgICAgICAgbm9kZS5lbWFpbCA9IGAke25vZGUubG9naW59QHVzZXJzLm5vcmVwbHkuZ2l0aHViLmNvbWA7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbmV3IEF1dGhvcihub2RlLmVtYWlsLCBub2RlLm5hbWUsIG5vZGUubG9naW4pO1xuICAgICAgfSk7XG4gICAgICB0aGlzLmFkZFVzZXJzKGF1dGhvcnMsIHNvdXJjZS5HSVRIVUJBUEkpO1xuICAgICAgcmVtb3RlVXNlcnMucHVzaCguLi5hdXRob3JzKTtcblxuICAgICAgY3Vyc29yID0gY29ubmVjdGlvbi5wYWdlSW5mby5lbmRDdXJzb3I7XG4gICAgICBoYXNNb3JlID0gY29ubmVjdGlvbi5wYWdlSW5mby5oYXNOZXh0UGFnZTtcbiAgICB9XG5cbiAgICB0aGlzLmNhY2hlLnNldChyZW1vdGUsIHJlbW90ZVVzZXJzKTtcbiAgfVxuXG4gIGFkZFVzZXJzKHVzZXJzLCBuZXh0U291cmNlKSB7XG4gICAgbGV0IGNoYW5nZWQgPSBmYWxzZTtcblxuICAgIGlmIChcbiAgICAgIG5leHRTb3VyY2UgIT09IHRoaXMubGFzdC5zb3VyY2UgfHxcbiAgICAgIHRoaXMucmVwb3NpdG9yeU9ic2VydmVyLmdldEFjdGl2ZU1vZGVsKCkgIT09IHRoaXMubGFzdC5yZXBvc2l0b3J5IHx8XG4gICAgICB0aGlzLmV4Y2x1ZGVkVXNlcnMgIT09IHRoaXMubGFzdC5leGNsdWRlZFVzZXJzXG4gICAgKSB7XG4gICAgICBjaGFuZ2VkID0gdHJ1ZTtcbiAgICAgIHRoaXMuYWxsVXNlcnMuY2xlYXIoKTtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IGF1dGhvciBvZiB1c2Vycykge1xuICAgICAgaWYgKCF0aGlzLmFsbFVzZXJzLmhhcyhhdXRob3IuZ2V0RW1haWwoKSkpIHtcbiAgICAgICAgY2hhbmdlZCA9IHRydWU7XG4gICAgICB9XG4gICAgICB0aGlzLmFsbFVzZXJzLnNldChhdXRob3IuZ2V0RW1haWwoKSwgYXV0aG9yKTtcbiAgICB9XG5cbiAgICBpZiAoY2hhbmdlZCkge1xuICAgICAgdGhpcy5maW5hbGl6ZSgpO1xuICAgIH1cbiAgICB0aGlzLmxhc3Quc291cmNlID0gbmV4dFNvdXJjZTtcbiAgICB0aGlzLmxhc3QucmVwb3NpdG9yeSA9IHRoaXMucmVwb3NpdG9yeU9ic2VydmVyLmdldEFjdGl2ZU1vZGVsKCk7XG4gICAgdGhpcy5sYXN0LmV4Y2x1ZGVkVXNlcnMgPSB0aGlzLmV4Y2x1ZGVkVXNlcnM7XG4gIH1cblxuICBmaW5hbGl6ZSgpIHtcbiAgICAvLyBUT0RPOiBba3UgMy8yMDE4XSBjb25zaWRlciBzb3J0aW5nIGJhc2VkIG9uIG1vc3QgcmVjZW50IGF1dGhvcnMgb3IgY29tbWl0IGZyZXF1ZW5jeVxuICAgIGNvbnN0IHVzZXJzID0gW107XG4gICAgZm9yIChjb25zdCBhdXRob3Igb2YgdGhpcy5hbGxVc2Vycy52YWx1ZXMoKSkge1xuICAgICAgaWYgKGF1dGhvci5tYXRjaGVzKHRoaXMuY29tbWl0dGVyKSkgeyBjb250aW51ZTsgfVxuICAgICAgaWYgKGF1dGhvci5pc05vUmVwbHkoKSkgeyBjb250aW51ZTsgfVxuICAgICAgaWYgKHRoaXMuZXhjbHVkZWRVc2Vycy5oYXMoYXV0aG9yLmdldEVtYWlsKCkpKSB7IGNvbnRpbnVlOyB9XG5cbiAgICAgIHVzZXJzLnB1c2goYXV0aG9yKTtcbiAgICB9XG4gICAgdXNlcnMuc29ydChBdXRob3IuY29tcGFyZSk7XG4gICAgdGhpcy51c2VycyA9IHVzZXJzO1xuICAgIHRoaXMuZGlkVXBkYXRlKCk7XG4gIH1cblxuICBzZXRSZXBvc2l0b3J5KHJlcG9zaXRvcnkpIHtcbiAgICB0aGlzLnJlcG9zaXRvcnlPYnNlcnZlci5zZXRBY3RpdmVNb2RlbChyZXBvc2l0b3J5KTtcbiAgfVxuXG4gIHNldExvZ2luTW9kZWwobG9naW4pIHtcbiAgICB0aGlzLmxvZ2luT2JzZXJ2ZXIuc2V0QWN0aXZlTW9kZWwobG9naW4pO1xuICB9XG5cbiAgc2V0Q29tbWl0dGVyKGNvbW1pdHRlcikge1xuICAgIGNvbnN0IGNoYW5nZWQgPSAhdGhpcy5jb21taXR0ZXIubWF0Y2hlcyhjb21taXR0ZXIpO1xuICAgIHRoaXMuY29tbWl0dGVyID0gY29tbWl0dGVyO1xuICAgIGlmIChjaGFuZ2VkKSB7XG4gICAgICB0aGlzLmZpbmFsaXplKCk7XG4gICAgfVxuICB9XG5cbiAgZGlkVXBkYXRlKCkge1xuICAgIHRoaXMuZW1pdHRlci5lbWl0KCdkaWQtdXBkYXRlJywgdGhpcy5nZXRVc2VycygpKTtcbiAgfVxuXG4gIG9uRGlkVXBkYXRlKGNhbGxiYWNrKSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5vbignZGlkLXVwZGF0ZScsIGNhbGxiYWNrKTtcbiAgfVxuXG4gIGdldFVzZXJzKCkge1xuICAgIHJldHVybiB0aGlzLnVzZXJzO1xuICB9XG59XG4iXX0=