"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.FOCUS = void 0;

var _path = _interopRequireDefault(require("path"));

var _eventKit = require("event-kit");

var _atom = require("atom");

var _eventLogger = _interopRequireDefault(require("./event-logger"));

var _helpers = require("../helpers");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const FOCUS = Symbol('focus');
exports.FOCUS = FOCUS;

class WorkspaceChangeObserver {
  constructor(window, workspace, repository) {
    (0, _helpers.autobind)(this, 'observeTextEditor');
    this.window = window;
    this.repository = repository;
    this.workspace = workspace;
    this.observedBuffers = new WeakSet();
    this.emitter = new _eventKit.Emitter();
    this.disposables = new _eventKit.CompositeDisposable();
    this.logger = new _eventLogger.default('workspace watcher');
    this.started = false;
  }

  async start() {
    const focusHandler = event => {
      if (this.repository) {
        this.logger.showFocusEvent();
        this.didChange([{
          special: FOCUS
        }]);
      }
    };

    this.window.addEventListener('focus', focusHandler);
    this.disposables.add(this.workspace.observeTextEditors(this.observeTextEditor), new _eventKit.Disposable(() => this.window.removeEventListener('focus', focusHandler)));
    await this.watchActiveRepositoryGitDirectory();
    this.started = true;
    return this;
  }

  async destroy() {
    this.started = false;
    this.observedBuffers = new WeakSet();
    this.emitter.dispose();
    this.disposables.dispose();
    await this.stopCurrentFileWatcher();
  }

  isStarted() {
    return this.started;
  }

  didChange(payload) {
    this.emitter.emit('did-change', payload);
  }

  didChangeWorkdirOrHead() {
    this.emitter.emit('did-change-workdir-or-head');
  }

  onDidChange(callback) {
    return this.emitter.on('did-change', callback);
  }

  onDidChangeWorkdirOrHead(callback) {
    return this.emitter.on('did-change-workdir-or-head', callback);
  }

  getRepository() {
    return this.repository;
  }

  async watchActiveRepositoryGitDirectory() {
    const repository = this.getRepository();
    const gitDirectoryPath = repository.getGitDirectoryPath();
    const basenamesOfInterest = ['config', 'index', 'HEAD', 'MERGE_HEAD'];
    const workdirOrHeadBasenames = ['config', 'index'];

    const eventPaths = event => {
      const ps = [event.path];

      if (event.oldPath) {
        ps.push(event.oldPath);
      }

      return ps;
    };

    const acceptEvent = event => {
      return eventPaths(event).some(eventPath => {
        return basenamesOfInterest.includes(_path.default.basename(eventPath)) || _path.default.dirname(eventPath).includes(_path.default.join('.git', 'refs'));
      });
    };

    const isWorkdirOrHeadEvent = event => {
      return eventPaths(event).some(eventPath => workdirOrHeadBasenames.includes(_path.default.basename(eventPath)));
    };

    this.currentFileWatcher = await (0, _atom.watchPath)(gitDirectoryPath, {}, events => {
      const filteredEvents = events.filter(acceptEvent);

      if (filteredEvents.length) {
        this.logger.showEvents(filteredEvents);
        this.didChange(filteredEvents);

        if (filteredEvents.some(isWorkdirOrHeadEvent)) {
          this.logger.showWorkdirOrHeadEvents();
          this.didChangeWorkdirOrHead();
        }
      }
    });
    this.currentFileWatcher.onDidError(error => {
      const workingDirectory = repository.getWorkingDirectoryPath(); // eslint-disable-next-line no-console

      console.warn(`Error in WorkspaceChangeObserver in ${workingDirectory}:`, error);
      this.stopCurrentFileWatcher();
    });
    this.logger.showStarted(gitDirectoryPath, 'workspace emulated');
  }

  stopCurrentFileWatcher() {
    if (this.currentFileWatcher) {
      this.currentFileWatcher.dispose();
      this.currentFileWatcher = null;
      this.logger.showStopped();
    }

    return Promise.resolve();
  }

  activeRepositoryContainsPath(filePath) {
    const repository = this.getRepository();

    if (filePath && repository) {
      return filePath.indexOf(repository.getWorkingDirectoryPath()) !== -1;
    } else {
      return false;
    }
  }

  observeTextEditor(editor) {
    const buffer = editor.getBuffer();

    if (!this.observedBuffers.has(buffer)) {
      let lastPath = buffer.getPath();

      const didChange = () => {
        const currentPath = buffer.getPath();
        const events = currentPath === lastPath ? [{
          action: 'modified',
          path: currentPath
        }] : [{
          action: 'renamed',
          path: currentPath,
          oldPath: lastPath
        }];
        lastPath = currentPath;
        this.logger.showEvents(events);
        this.didChange(events);
      };

      this.observedBuffers.add(buffer);
      const disposables = new _eventKit.CompositeDisposable(buffer.onDidSave(() => {
        if (this.activeRepositoryContainsPath(buffer.getPath())) {
          didChange();
        }
      }), buffer.onDidReload(() => {
        if (this.activeRepositoryContainsPath(buffer.getPath())) {
          didChange();
        }
      }), buffer.onDidDestroy(() => {
        if (this.activeRepositoryContainsPath(buffer.getPath())) {
          didChange();
        }

        disposables.dispose();
      }));
      this.disposables.add(disposables);
    }
  }

}

exports.default = WorkspaceChangeObserver;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9tb2RlbHMvd29ya3NwYWNlLWNoYW5nZS1vYnNlcnZlci5qcyJdLCJuYW1lcyI6WyJGT0NVUyIsIlN5bWJvbCIsIldvcmtzcGFjZUNoYW5nZU9ic2VydmVyIiwiY29uc3RydWN0b3IiLCJ3aW5kb3ciLCJ3b3Jrc3BhY2UiLCJyZXBvc2l0b3J5Iiwib2JzZXJ2ZWRCdWZmZXJzIiwiV2Vha1NldCIsImVtaXR0ZXIiLCJFbWl0dGVyIiwiZGlzcG9zYWJsZXMiLCJDb21wb3NpdGVEaXNwb3NhYmxlIiwibG9nZ2VyIiwiRXZlbnRMb2dnZXIiLCJzdGFydGVkIiwic3RhcnQiLCJmb2N1c0hhbmRsZXIiLCJldmVudCIsInNob3dGb2N1c0V2ZW50IiwiZGlkQ2hhbmdlIiwic3BlY2lhbCIsImFkZEV2ZW50TGlzdGVuZXIiLCJhZGQiLCJvYnNlcnZlVGV4dEVkaXRvcnMiLCJvYnNlcnZlVGV4dEVkaXRvciIsIkRpc3Bvc2FibGUiLCJyZW1vdmVFdmVudExpc3RlbmVyIiwid2F0Y2hBY3RpdmVSZXBvc2l0b3J5R2l0RGlyZWN0b3J5IiwiZGVzdHJveSIsImRpc3Bvc2UiLCJzdG9wQ3VycmVudEZpbGVXYXRjaGVyIiwiaXNTdGFydGVkIiwicGF5bG9hZCIsImVtaXQiLCJkaWRDaGFuZ2VXb3JrZGlyT3JIZWFkIiwib25EaWRDaGFuZ2UiLCJjYWxsYmFjayIsIm9uIiwib25EaWRDaGFuZ2VXb3JrZGlyT3JIZWFkIiwiZ2V0UmVwb3NpdG9yeSIsImdpdERpcmVjdG9yeVBhdGgiLCJnZXRHaXREaXJlY3RvcnlQYXRoIiwiYmFzZW5hbWVzT2ZJbnRlcmVzdCIsIndvcmtkaXJPckhlYWRCYXNlbmFtZXMiLCJldmVudFBhdGhzIiwicHMiLCJwYXRoIiwib2xkUGF0aCIsInB1c2giLCJhY2NlcHRFdmVudCIsInNvbWUiLCJldmVudFBhdGgiLCJpbmNsdWRlcyIsImJhc2VuYW1lIiwiZGlybmFtZSIsImpvaW4iLCJpc1dvcmtkaXJPckhlYWRFdmVudCIsImN1cnJlbnRGaWxlV2F0Y2hlciIsImV2ZW50cyIsImZpbHRlcmVkRXZlbnRzIiwiZmlsdGVyIiwibGVuZ3RoIiwic2hvd0V2ZW50cyIsInNob3dXb3JrZGlyT3JIZWFkRXZlbnRzIiwib25EaWRFcnJvciIsImVycm9yIiwid29ya2luZ0RpcmVjdG9yeSIsImdldFdvcmtpbmdEaXJlY3RvcnlQYXRoIiwiY29uc29sZSIsIndhcm4iLCJzaG93U3RhcnRlZCIsInNob3dTdG9wcGVkIiwiUHJvbWlzZSIsInJlc29sdmUiLCJhY3RpdmVSZXBvc2l0b3J5Q29udGFpbnNQYXRoIiwiZmlsZVBhdGgiLCJpbmRleE9mIiwiZWRpdG9yIiwiYnVmZmVyIiwiZ2V0QnVmZmVyIiwiaGFzIiwibGFzdFBhdGgiLCJnZXRQYXRoIiwiY3VycmVudFBhdGgiLCJhY3Rpb24iLCJvbkRpZFNhdmUiLCJvbkRpZFJlbG9hZCIsIm9uRGlkRGVzdHJveSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOzs7O0FBRU8sTUFBTUEsS0FBSyxHQUFHQyxNQUFNLENBQUMsT0FBRCxDQUFwQjs7O0FBRVEsTUFBTUMsdUJBQU4sQ0FBOEI7QUFDM0NDLEVBQUFBLFdBQVcsQ0FBQ0MsTUFBRCxFQUFTQyxTQUFULEVBQW9CQyxVQUFwQixFQUFnQztBQUN6QywyQkFBUyxJQUFULEVBQWUsbUJBQWY7QUFFQSxTQUFLRixNQUFMLEdBQWNBLE1BQWQ7QUFDQSxTQUFLRSxVQUFMLEdBQWtCQSxVQUFsQjtBQUNBLFNBQUtELFNBQUwsR0FBaUJBLFNBQWpCO0FBQ0EsU0FBS0UsZUFBTCxHQUF1QixJQUFJQyxPQUFKLEVBQXZCO0FBQ0EsU0FBS0MsT0FBTCxHQUFlLElBQUlDLGlCQUFKLEVBQWY7QUFDQSxTQUFLQyxXQUFMLEdBQW1CLElBQUlDLDZCQUFKLEVBQW5CO0FBQ0EsU0FBS0MsTUFBTCxHQUFjLElBQUlDLG9CQUFKLENBQWdCLG1CQUFoQixDQUFkO0FBQ0EsU0FBS0MsT0FBTCxHQUFlLEtBQWY7QUFDRDs7QUFFRCxR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QSxRQUFBQSxRQUFRLEdBQUdFLFdBQVg7QUFDQSxhQUFLdkUsTUFBTCxDQUFZa0QsVUFBWixDQUF1QkosTUFBdkI7QUFDQSxhQUFLdkMsU0FBTCxDQUFldUMsTUFBZjtBQUNELE9BUkQ7O0FBVUEsV0FBS3BELGVBQUwsQ0FBcUJnQixHQUFyQixDQUF5QndELE1BQXpCO0FBQ0EsWUFBTXBFLFdBQVcsR0FBRyxJQUFJQyw2QkFBSixDQUNsQm1FLE1BQU0sQ0FBQ08sU0FBUCxDQUFpQixNQUFNO0FBQ3JCLFlBQUksS0FBS1gsNEJBQUwsQ0FBa0NJLE1BQU0sQ0FBQ0ksT0FBUCxFQUFsQyxDQUFKLEVBQXlEO0FBQ3ZEL0QsVUFBQUEsU0FBUztBQUNWO0FBQ0YsT0FKRCxDQURrQixFQU1sQjJELE1BQU0sQ0FBQ1EsV0FBUCxDQUFtQixNQUFNO0FBQ3ZCLFlBQUksS0FBS1osNEJBQUwsQ0FBa0NJLE1BQU0sQ0FBQ0ksT0FBUCxFQUFsQyxDQUFKLEVBQXlEO0FBQ3ZEL0QsVUFBQUEsU0FBUztBQUNWO0FBQ0YsT0FKRCxDQU5rQixFQVdsQjJELE1BQU0sQ0FBQ1MsWUFBUCxDQUFvQixNQUFNO0FBQ3hCLFlBQUksS0FBS2IsNEJBQUwsQ0FBa0NJLE1BQU0sQ0FBQ0ksT0FBUCxFQUFsQyxDQUFKLEVBQXlEO0FBQ3ZEL0QsVUFBQUEsU0FBUztBQUNWOztBQUNEVCxRQUFBQSxXQUFXLENBQUNtQixPQUFaO0FBQ0QsT0FMRCxDQVhrQixDQUFwQjtBQWtCQSxXQUFLbkIsV0FBTCxDQUFpQlksR0FBakIsQ0FBcUJaLFdBQXJCO0FBQ0Q7QUFDRjs7QUFuSzBDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQge0NvbXBvc2l0ZURpc3Bvc2FibGUsIERpc3Bvc2FibGUsIEVtaXR0ZXJ9IGZyb20gJ2V2ZW50LWtpdCc7XG5pbXBvcnQge3dhdGNoUGF0aH0gZnJvbSAnYXRvbSc7XG5cbmltcG9ydCBFdmVudExvZ2dlciBmcm9tICcuL2V2ZW50LWxvZ2dlcic7XG5pbXBvcnQge2F1dG9iaW5kfSBmcm9tICcuLi9oZWxwZXJzJztcblxuZXhwb3J0IGNvbnN0IEZPQ1VTID0gU3ltYm9sKCdmb2N1cycpO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBXb3Jrc3BhY2VDaGFuZ2VPYnNlcnZlciB7XG4gIGNvbnN0cnVjdG9yKHdpbmRvdywgd29ya3NwYWNlLCByZXBvc2l0b3J5KSB7XG4gICAgYXV0b2JpbmQodGhpcywgJ29ic2VydmVUZXh0RWRpdG9yJyk7XG5cbiAgICB0aGlzLndpbmRvdyA9IHdpbmRvdztcbiAgICB0aGlzLnJlcG9zaXRvcnkgPSByZXBvc2l0b3J5O1xuICAgIHRoaXMud29ya3NwYWNlID0gd29ya3NwYWNlO1xuICAgIHRoaXMub2JzZXJ2ZWRCdWZmZXJzID0gbmV3IFdlYWtTZXQoKTtcbiAgICB0aGlzLmVtaXR0ZXIgPSBuZXcgRW1pdHRlcigpO1xuICAgIHRoaXMuZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpO1xuICAgIHRoaXMubG9nZ2VyID0gbmV3IEV2ZW50TG9nZ2VyKCd3b3Jrc3BhY2Ugd2F0Y2hlcicpO1xuICAgIHRoaXMuc3RhcnRlZCA9IGZhbHNlO1xuICB9XG5cbiAgYXN5bmMgc3RhcnQoKSB7XG4gICAgY29uc3QgZm9jdXNIYW5kbGVyID0gZXZlbnQgPT4ge1xuICAgICAgaWYgKHRoaXMucmVwb3NpdG9yeSkge1xuICAgICAgICB0aGlzLmxvZ2dlci5zaG93Rm9jdXNFdmVudCgpO1xuICAgICAgICB0aGlzLmRpZENoYW5nZShbe3NwZWNpYWw6IEZPQ1VTfV0pO1xuICAgICAgfVxuICAgIH07XG4gICAgdGhpcy53aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignZm9jdXMnLCBmb2N1c0hhbmRsZXIpO1xuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKFxuICAgICAgdGhpcy53b3Jrc3BhY2Uub2JzZXJ2ZVRleHRFZGl0b3JzKHRoaXMub2JzZXJ2ZVRleHRFZGl0b3IpLFxuICAgICAgbmV3IERpc3Bvc2FibGUoKCkgPT4gdGhpcy53aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignZm9jdXMnLCBmb2N1c0hhbmRsZXIpKSxcbiAgICApO1xuICAgIGF3YWl0IHRoaXMud2F0Y2hBY3RpdmVSZXBvc2l0b3J5R2l0RGlyZWN0b3J5KCk7XG4gICAgdGhpcy5zdGFydGVkID0gdHJ1ZTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGFzeW5jIGRlc3Ryb3koKSB7XG4gICAgdGhpcy5zdGFydGVkID0gZmFsc2U7XG4gICAgdGhpcy5vYnNlcnZlZEJ1ZmZlcnMgPSBuZXcgV2Vha1NldCgpO1xuICAgIHRoaXMuZW1pdHRlci5kaXNwb3NlKCk7XG4gICAgdGhpcy5kaXNwb3NhYmxlcy5kaXNwb3NlKCk7XG4gICAgYXdhaXQgdGhpcy5zdG9wQ3VycmVudEZpbGVXYXRjaGVyKCk7XG4gIH1cblxuICBpc1N0YXJ0ZWQoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3RhcnRlZDtcbiAgfVxuXG4gIGRpZENoYW5nZShwYXlsb2FkKSB7XG4gICAgdGhpcy5lbWl0dGVyLmVtaXQoJ2RpZC1jaGFuZ2UnLCBwYXlsb2FkKTtcbiAgfVxuXG4gIGRpZENoYW5nZVdvcmtkaXJPckhlYWQoKSB7XG4gICAgdGhpcy5lbWl0dGVyLmVtaXQoJ2RpZC1jaGFuZ2Utd29ya2Rpci1vci1oZWFkJyk7XG4gIH1cblxuICBvbkRpZENoYW5nZShjYWxsYmFjaykge1xuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIub24oJ2RpZC1jaGFuZ2UnLCBjYWxsYmFjayk7XG4gIH1cblxuICBvbkRpZENoYW5nZVdvcmtkaXJPckhlYWQoY2FsbGJhY2spIHtcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLm9uKCdkaWQtY2hhbmdlLXdvcmtkaXItb3ItaGVhZCcsIGNhbGxiYWNrKTtcbiAgfVxuXG4gIGdldFJlcG9zaXRvcnkoKSB7XG4gICAgcmV0dXJuIHRoaXMucmVwb3NpdG9yeTtcbiAgfVxuXG4gIGFzeW5jIHdhdGNoQWN0aXZlUmVwb3NpdG9yeUdpdERpcmVjdG9yeSgpIHtcbiAgICBjb25zdCByZXBvc2l0b3J5ID0gdGhpcy5nZXRSZXBvc2l0b3J5KCk7XG4gICAgY29uc3QgZ2l0RGlyZWN0b3J5UGF0aCA9IHJlcG9zaXRvcnkuZ2V0R2l0RGlyZWN0b3J5UGF0aCgpO1xuXG4gICAgY29uc3QgYmFzZW5hbWVzT2ZJbnRlcmVzdCA9IFsnY29uZmlnJywgJ2luZGV4JywgJ0hFQUQnLCAnTUVSR0VfSEVBRCddO1xuICAgIGNvbnN0IHdvcmtkaXJPckhlYWRCYXNlbmFtZXMgPSBbJ2NvbmZpZycsICdpbmRleCddO1xuXG4gICAgY29uc3QgZXZlbnRQYXRocyA9IGV2ZW50ID0+IHtcbiAgICAgIGNvbnN0IHBzID0gW2V2ZW50LnBhdGhdO1xuICAgICAgaWYgKGV2ZW50Lm9sZFBhdGgpIHsgcHMucHVzaChldmVudC5vbGRQYXRoKTsgfVxuICAgICAgcmV0dXJuIHBzO1xuICAgIH07XG5cbiAgICBjb25zdCBhY2NlcHRFdmVudCA9IGV2ZW50ID0+IHtcbiAgICAgIHJldHVybiBldmVudFBhdGhzKGV2ZW50KS5zb21lKGV2ZW50UGF0aCA9PiB7XG4gICAgICAgIHJldHVybiBiYXNlbmFtZXNPZkludGVyZXN0LmluY2x1ZGVzKHBhdGguYmFzZW5hbWUoZXZlbnRQYXRoKSkgfHxcbiAgICAgICAgICBwYXRoLmRpcm5hbWUoZXZlbnRQYXRoKS5pbmNsdWRlcyhwYXRoLmpvaW4oJy5naXQnLCAncmVmcycpKTtcbiAgICAgIH0pO1xuICAgIH07XG5cbiAgICBjb25zdCBpc1dvcmtkaXJPckhlYWRFdmVudCA9IGV2ZW50ID0+IHtcbiAgICAgIHJldHVybiBldmVudFBhdGhzKGV2ZW50KS5zb21lKGV2ZW50UGF0aCA9PiB3b3JrZGlyT3JIZWFkQmFzZW5hbWVzLmluY2x1ZGVzKHBhdGguYmFzZW5hbWUoZXZlbnRQYXRoKSkpO1xuICAgIH07XG5cbiAgICB0aGlzLmN1cnJlbnRGaWxlV2F0Y2hlciA9IGF3YWl0IHdhdGNoUGF0aChnaXREaXJlY3RvcnlQYXRoLCB7fSwgZXZlbnRzID0+IHtcbiAgICAgIGNvbnN0IGZpbHRlcmVkRXZlbnRzID0gZXZlbnRzLmZpbHRlcihhY2NlcHRFdmVudCk7XG5cbiAgICAgIGlmIChmaWx0ZXJlZEV2ZW50cy5sZW5ndGgpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIuc2hvd0V2ZW50cyhmaWx0ZXJlZEV2ZW50cyk7XG4gICAgICAgIHRoaXMuZGlkQ2hhbmdlKGZpbHRlcmVkRXZlbnRzKTtcbiAgICAgICAgaWYgKGZpbHRlcmVkRXZlbnRzLnNvbWUoaXNXb3JrZGlyT3JIZWFkRXZlbnQpKSB7XG4gICAgICAgICAgdGhpcy5sb2dnZXIuc2hvd1dvcmtkaXJPckhlYWRFdmVudHMoKTtcbiAgICAgICAgICB0aGlzLmRpZENoYW5nZVdvcmtkaXJPckhlYWQoKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgdGhpcy5jdXJyZW50RmlsZVdhdGNoZXIub25EaWRFcnJvcihlcnJvciA9PiB7XG4gICAgICBjb25zdCB3b3JraW5nRGlyZWN0b3J5ID0gcmVwb3NpdG9yeS5nZXRXb3JraW5nRGlyZWN0b3J5UGF0aCgpO1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGVcbiAgICAgIGNvbnNvbGUud2FybihgRXJyb3IgaW4gV29ya3NwYWNlQ2hhbmdlT2JzZXJ2ZXIgaW4gJHt3b3JraW5nRGlyZWN0b3J5fTpgLCBlcnJvcik7XG4gICAgICB0aGlzLnN0b3BDdXJyZW50RmlsZVdhdGNoZXIoKTtcbiAgICB9KTtcblxuICAgIHRoaXMubG9nZ2VyLnNob3dTdGFydGVkKGdpdERpcmVjdG9yeVBhdGgsICd3b3Jrc3BhY2UgZW11bGF0ZWQnKTtcbiAgfVxuXG4gIHN0b3BDdXJyZW50RmlsZVdhdGNoZXIoKSB7XG4gICAgaWYgKHRoaXMuY3VycmVudEZpbGVXYXRjaGVyKSB7XG4gICAgICB0aGlzLmN1cnJlbnRGaWxlV2F0Y2hlci5kaXNwb3NlKCk7XG4gICAgICB0aGlzLmN1cnJlbnRGaWxlV2F0Y2hlciA9IG51bGw7XG4gICAgICB0aGlzLmxvZ2dlci5zaG93U3RvcHBlZCgpO1xuICAgIH1cbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gIH1cblxuICBhY3RpdmVSZXBvc2l0b3J5Q29udGFpbnNQYXRoKGZpbGVQYXRoKSB7XG4gICAgY29uc3QgcmVwb3NpdG9yeSA9IHRoaXMuZ2V0UmVwb3NpdG9yeSgpO1xuICAgIGlmIChmaWxlUGF0aCAmJiByZXBvc2l0b3J5KSB7XG4gICAgICByZXR1cm4gZmlsZVBhdGguaW5kZXhPZihyZXBvc2l0b3J5LmdldFdvcmtpbmdEaXJlY3RvcnlQYXRoKCkpICE9PSAtMTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIG9ic2VydmVUZXh0RWRpdG9yKGVkaXRvcikge1xuICAgIGNvbnN0IGJ1ZmZlciA9IGVkaXRvci5nZXRCdWZmZXIoKTtcbiAgICBpZiAoIXRoaXMub2JzZXJ2ZWRCdWZmZXJzLmhhcyhidWZmZXIpKSB7XG4gICAgICBsZXQgbGFzdFBhdGggPSBidWZmZXIuZ2V0UGF0aCgpO1xuICAgICAgY29uc3QgZGlkQ2hhbmdlID0gKCkgPT4ge1xuICAgICAgICBjb25zdCBjdXJyZW50UGF0aCA9IGJ1ZmZlci5nZXRQYXRoKCk7XG4gICAgICAgIGNvbnN0IGV2ZW50cyA9IGN1cnJlbnRQYXRoID09PSBsYXN0UGF0aCA/XG4gICAgICAgICAgW3thY3Rpb246ICdtb2RpZmllZCcsIHBhdGg6IGN1cnJlbnRQYXRofV0gOlxuICAgICAgICAgIFt7YWN0aW9uOiAncmVuYW1lZCcsIHBhdGg6IGN1cnJlbnRQYXRoLCBvbGRQYXRoOiBsYXN0UGF0aH1dO1xuICAgICAgICBsYXN0UGF0aCA9IGN1cnJlbnRQYXRoO1xuICAgICAgICB0aGlzLmxvZ2dlci5zaG93RXZlbnRzKGV2ZW50cyk7XG4gICAgICAgIHRoaXMuZGlkQ2hhbmdlKGV2ZW50cyk7XG4gICAgICB9O1xuXG4gICAgICB0aGlzLm9ic2VydmVkQnVmZmVycy5hZGQoYnVmZmVyKTtcbiAgICAgIGNvbnN0IGRpc3Bvc2FibGVzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoXG4gICAgICAgIGJ1ZmZlci5vbkRpZFNhdmUoKCkgPT4ge1xuICAgICAgICAgIGlmICh0aGlzLmFjdGl2ZVJlcG9zaXRvcnlDb250YWluc1BhdGgoYnVmZmVyLmdldFBhdGgoKSkpIHtcbiAgICAgICAgICAgIGRpZENoYW5nZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSksXG4gICAgICAgIGJ1ZmZlci5vbkRpZFJlbG9hZCgoKSA9PiB7XG4gICAgICAgICAgaWYgKHRoaXMuYWN0aXZlUmVwb3NpdG9yeUNvbnRhaW5zUGF0aChidWZmZXIuZ2V0UGF0aCgpKSkge1xuICAgICAgICAgICAgZGlkQ2hhbmdlKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KSxcbiAgICAgICAgYnVmZmVyLm9uRGlkRGVzdHJveSgoKSA9PiB7XG4gICAgICAgICAgaWYgKHRoaXMuYWN0aXZlUmVwb3NpdG9yeUNvbnRhaW5zUGF0aChidWZmZXIuZ2V0UGF0aCgpKSkge1xuICAgICAgICAgICAgZGlkQ2hhbmdlKCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGRpc3Bvc2FibGVzLmRpc3Bvc2UoKTtcbiAgICAgICAgfSksXG4gICAgICApO1xuICAgICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoZGlzcG9zYWJsZXMpO1xuICAgIH1cbiAgfVxufVxuIl19